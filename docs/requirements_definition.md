# 要件定義書：葬儀搬送業務支援AIアプリ（仮称：搬送アシスト）

> **紙ベースのスケジュール管理をデジタル化し、事業所全体でリアルタイムに共有するアプリ**

---

## 1. プロジェクト概要

### 1.1 背景と目的
遺体搬送業務の現場では、以下の深刻な課題が存在する。

| 課題 | 現状 | 影響 |
|------|------|------|
| 安置先探し | 夜間、空いている葬儀社へ何件も電話確認 | 精神的疲弊・搬送遅延 |
| 情報の属人化 | 病院ごとの搬入手順がベテランの頭の中だけに | 新人の不安・教育コスト増 |
| アナログな情報共有 | 手書きの受付状況表をFAXやPCに手入力 | 入力ミス・リアルタイム性の欠如 |
| 24時間待機の過酷さ | 深夜でも電話確認で叩き起こされる | 離職率の上昇・人手不足の加速 |

本アプリは、これらの課題を**「スケジュール管理」を核とした仕組み**で解決し、搬送スタッフが「ご遺族への配慮」に専念できる環境を構築することを目的とする。

### 1.2 成功指標（KPI）

| KPI | 現状（推定） | 目標 | 計測方法 |
|-----|----------|------|----------|
| 安置先決定までの所要時間 | 約60分（電話確認含む） | **20分以内** | アプリの操作ログ |
| 夜間の電話確認回数 | 5〜10件／一搬送 | **0件** | スタッフヒアリング |
| 新人が単独搬送可能になるまでの期間 | 約1ヶ月 | **1週間** | 教育記録 |
| スケジュール登録の所要時間 | 約15分（手入力） | **30秒（撮影のみ）** | アプリの操作ログ |

### 1.3 対象ユーザー

| ユーザー種別 | 主な利用シーン | 利用デバイス |
|-------------|---------------|-------------|
| 搬送スタッフ | 搬送車内・現場での情報確認 | スマートフォン |
| 配車担当（事務所） | 空き状況の全体把握・スタッフへの指示 | PC / タブレット |
| 葬儀社スタッフ（将来） | 自社の空き状況の登録・更新 | スマートフォン / PC |

---

## 2. 機能要件

### 2.1 画像解析・デジタル化機能（OCR）

> **コンセプト**: 「撮るだけで情報が共有される」

| 項目 | 内容 |
|------|------|
| **入力** | スマホカメラで撮影した紙資料（葬儀受付状況表など） |
| **処理** | AI（Gemini等のマルチモーダルLLM）が画像を解析 |
| **出力** | 構造化データ（施設名・日付・空き/使用中の判定） |

**詳細要件：**
- [ ] 手書き文字（日本語）の認識精度：90%以上を目標
- [ ] 「×」「○」「△」等の記号認識
- [ ] 複数フォーマットへの対応（葬儀社ごとに異なる書式を想定）
- [ ] 撮影後3秒以内にデータ解析完了（目標）
- [ ] 解析結果のプレビュー表示と手動修正機能

### 2.2 スケジュール管理・リアルタイム共有機能（★コア機能）

> **コンセプト**: 「全員が同じスケジュールを、同時に見られる」

| 項目 | 内容 |
|------|------|
| **データ同期** | クラウドDB（Supabase）によるリアルタイム同期 |
| **表示形式** | リストビュー（施設別）+ カレンダービュー（日付別）|
| **更新通知** | プッシュ通知 / アプリ内バッジ |

**詳細要件：**
- [x] **リストビュー（メイン画面）**：施設ごとの空き状況を一覧表示
  - 施設名、空き室数、次回利用可能時刻、連絡先
  - ステータス色分け：空き＝緑、使用中＝赤、不明＝グレー
- [ ] **カレンダービュー**：日付切り替え（今日／明日／今週）で全施設の予定を一覧
- [x] データ更新時、全接続端末へ1秒以内に反映
- [ ] オフライン時はローカルキャッシュを表示し、復帰時に自動同期
- [ ] フィルター機能（エリア・施設タイプ）

> **注**: 業務従事者は施設の場所をすでに把握しているため、地図（マップビュー）は不要。リストとカレンダーで十分。

### 2.3 AIチャット機能（コンシェルジュ）

> **コンセプト**: 「聞けばすぐ答える、24時間対応のベテラン」

| 項目 | 内容 |
|------|------|
| **入力方式** | テキスト入力 + 音声入力（運転中対応） |
| **AI基盤** | Gemini API または同等のLLM |
| **知識ベース** | 空き状況DB + 社内ナレッジDB |

**詳細要件：**
- [ ] 自然言語での質問応答
  - 例1：「セレモニーホール田原は今空いてる？」→ 空き状況DBを参照して回答
  - 例2：「〇〇病院の夜間の搬入口はどこ？」→ ナレッジDBを参照して回答
  - 例3：「明日の午前で安置できるところを探して」→ 条件検索して候補を提示
- [ ] 音声入力対応（Web Speech API / ネイティブAPI）
- [ ] 音声読み上げ対応（ハンズフリー運転中に利用）
- [ ] 回答のソース（根拠）を明示する機能
- [ ] 会話履歴の保持（直近10件）

### 2.4 ナレッジ管理機能

> **コンセプト**: 「ベテランの知識を会社の資産に変える」

**詳細要件：**
- [ ] 病院・施設ごとの搬入手順の登録・編集
  - 搬入口の場所、暗証番号、駐車位置、注意事項など
- [ ] 宗派ごとのマナー・手順の登録
- [ ] 写真・画像の添付機能（搬入口の写真等）
- [ ] スタッフの誰もが追記・更新できるWiki形式
- [ ] 更新履歴の記録

### 2.5 六曜・友引カレンダー機能

> **コンセプト**: 「友引の日は葬儀・通夜をしない」という業界ルールをシステムに組み込む

**背景：**
葬儀業界では「六曜（ろくよう）」が業務スケジュールに直結する。特に**友引（ともびき）**の日は「友を引く」という意味から**葬儀・通夜は行わない**のが通例。多くの火葬場も友引を休業日としている。つまり：
- 友引の日は葬儀・通夜・火葬が原則として発生しない
- この日は施設の空き状況表示から除外するか、「休業日」として明確に扱う必要がある

**詳細要件：**
- [ ] 六曜データ（先勝・友引・先負・仏滅・大安・赤口）をカレンダーに常時表示
- [ ] **友引の日は「葬儀なし／火葬場休業日」として自動でブロック表示**
- [ ] 友引の日を空き状況の対象外とし、スケジュール登録時にも警告を表示
- [ ] 年末年始・お盆期間などの特殊日の登録機能
- [ ] 火葬場の定休日（友引以外）もマスターデータとして登録可能
- [ ] 六曜データは旧暦APIまたはローカルデータから自動取得（少なくとも5年分を事前生成）

---

## 3. 業務フロー（スケジュール更新）

```
葬儀社が受付状況表をFAX/メールで送付
          ↓
配車担当が紙資料をスマホで撮影
          ↓
   AI（OCR）が画像を解析
          ↓
解析結果をプレビュー → 配車担当が確認・修正
          ↓
スケジュールDBに保存 → 全スタッフにリアルタイム反映
```

**更新方法：**
- **OCR経由**（主）：葬儀社から届いた紙資料を撮影して登録
- **手動入力**（副）：電話確認結果や急な変更を配車担当がアプリ上で直接編集

---

## 4. データモデル

### 4.1 facilities（施設・会館マスター）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | TEXT | 施設名（例：セレモニー会館田原） |
| area | TEXT | エリア（例：田原・渡美・豊橋） |
| phone | TEXT | 連絡先電話番号 |
| notes | TEXT | 備考（「友引も営業」等） |
| is_active | BOOL | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### 4.2 halls（ホール・部屋）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| facility_id | UUID | FK→facilities（どの会館に属するか） |
| name | TEXT | ホール名（例：第1ホール、花の間） |
| capacity | INT | 収容人数（目安） |
| has_waiting_room | BOOL | 控室の有無 |
| notes | TEXT | 備考 |
| is_active | BOOL | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### 4.3 schedules（スケジュール） ★コアテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| hall_id | UUID | FK→halls（どのホールの予定か） |
| date | DATE | 対象日付 |
| slot_type | TEXT | 区分（葬儀・通夜） |
| family_name | TEXT | 喪家名（任意） |
| ceremony_time | TEXT | 開式時間（例：11:30） |
| status | TEXT | 空き（available）/ 使用中（occupied）/ 準備中（preparing） |
| registered_by | UUID | FK→users（誰が登録したか） |
| source | TEXT | 登録元（ocr / manual） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### 4.3 users（ユーザー）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー（Supabase Auth連携） |
| name | TEXT | 表示名 |
| role | TEXT | admin / dispatcher / driver |
| phone | TEXT | 電話番号 |
| is_active | BOOL | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |

### 4.4 knowledge（ナレッジ）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| facility_id | UUID | FK→facilities（任意、施設特有の情報の場合） |
| category | TEXT | カテゴリ（搬入手順・宗派マナー・その他） |
| title | TEXT | タイトル |
| content | TEXT | 本文（Markdown） |
| images | TEXT[] | 画像パスの配列 |
| updated_by | UUID | FK→users |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### 4.5 rokuyo（六曜マスター）

| カラム | 型 | 説明 |
|--------|-----|------|
| date | DATE | 主キー |
| rokuyo | TEXT | 先勝・友引・先負・仏滅・大安・赤口 |
| is_tomobiki | BOOL | 友引フラグ（クエリ最適化用） |

### 4.6 closed_days（休業日マスター）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| facility_id | UUID | FK→facilities（NULLの場合は全施設共通） |
| date | DATE | 休業日 |
| reason | TEXT | 理由（友引・年末年始・臨時休業等） |

---

## 5. 認証・ユーザー管理

### 5.1 認証方式
- Supabase Authによるメールアドレス + パスワード認証
- 初回ログイン時に管理者が発行した招待リンクを使用（不特定多数が登録できないようにする）

### 5.2 権限ロール

| ロール | スケジュール閲覧 | スケジュール編集 | 施設マスター編集 | ナレッジ編集 | ユーザー管理 |
|--------|:---:|:---:|:---:|:---:|:---:|
| admin（管理者） | ○ | ○ | ○ | ○ | ○ |
| dispatcher（配車担当） | ○ | ○ | ✕ | ○ | ✕ |
| driver（搬送スタッフ） | ○ | ✕ | ✕ | ○ | ✕ |

### 5.3 管理者画面
- 施設マスターのCRUD（施設の追加・編集・無効化）
- ユーザーの招待・ロール変更・無効化
- 休業日（友引以外）の手動登録

---

## 6. 非機能要件

| 項目 | 要件 |
|------|------|
| **可用性** | 24時間365日稼働（深夜の利用が多い業務特性） |
| **レスポンス** | 画面表示：1秒以内、AI回答：5秒以内 |
| **セキュリティ** | 通信暗号化（HTTPS）・認証必須・RLS（Row Level Security）によるデータ保護 |
| **対応端末** | iOS / Android（PWA）、PC（Webブラウザ） |
| **同時接続** | 最大20ユーザーを想定（初期フェーズ） |
| **データ保持** | 搬送記録：3年間、チャット履歴：1年間 |
| **バックアップ** | Supabaseの自動日次バックアップ + 手動エクスポート機能 |
| **監視** | Vercelアナリティクス + Supabaseダッシュボードで異常検知 |
| **ログ・監査** | スケジュールの作成・更新・削除の全操作をupdated_byとタイムスタンプで記録 |
| **APIコスト** | Gemini APIの月間利用上限を設定（目安：月額$50以内） |
| **UI** | 深夜の車内利用を考慮したダークモード対応 |
| **テスト** | 主要フロー（OCR→登録→一覧表示）のE2Eテストを整備 |

---

## 7. 技術スタック（案）

| レイヤー | 技術候補 | 選定理由 |
|---------|---------|----------|
| フロントエンド | Next.js（PWA）| iOS/Android/PC対応を1つのコードベースで実現 |
| バックエンド | Supabase | リアルタイム同期・認証・DBを統合管理 |
| AI/OCR | Gemini API | 画像解析（マルチモーダル）とチャットを1つのAPIで対応 |
| 通知 | Firebase Cloud Messaging | プッシュ通知 |
| ホスティング | Vercel | Next.jsとの高い親和性・自動デプロイ |

---

## 8. 画面構成（案）

```
┌─────────────────────────────────────────┐
│  スケジュール一覧（★メイン画面）              │
│  ├── 日付切り替え（今日／明日／今週）+ 六曜表示   │
│  ├── 施設ごとの空き状況カード一覧           │
│  ├── ステータス色分け（緑＝空き、赤＝使用中）     │
│  └── タップで施設詳細へ遷移                  │
├─────────────────────────────────────────┤
│  カメラ（撮るだけデジタル化）               │
│  ├── カメラ起動 → 撮影                    │
│  ├── AI解析結果のプレビュー                │
│  └── 確認ボタンでスケジュールに反映          │
├─────────────────────────────────────────┤
│  AIチャット                               │
│  ├── テキスト／音声入力                     │
│  ├── 会話履歴                             │
│  └── 音声読み上げ切替                       │
├─────────────────────────────────────────┤
│  ナレッジ                                 │
│  ├── 施設別マニュアル一覧                   │
│  ├── 検索機能                             │
│  └── 登録・編集フォーム                    │
└─────────────────────────────────────────┘

ボトムナビ: [一覧] [カメラ] [AI] [情報]
```

---

## 9. 開発フェーズ

| フェーズ | 内容 | 期間（目安） |
|---------|------|-------------|
| **Phase 1: MVP** | スケジュール手動登録 + リストビュー + カレンダー（六曜付き） | 2〜3週間 (進行中: ログイン/リストビュー実装済) |
| **Phase 2: OCR** | カメラ撮影→AI解析→スケジュール自動登録 | 2〜3週間 |
| **Phase 3: リアルタイム** | Supabase Realtimeによる複数端末同期 + プッシュ通知 | 2〜3週間 |
| **Phase 4: AIチャット** | Gemini APIによる質疑応答・音声入力 | 2〜3週間 |
| **Phase 5: ナレッジ** | 施設情報のCRUD・Wiki機能 | 2〜3週間 |
| **Phase 6: 本番運用** | セキュリティ強化・最適化・運用テスト | 2〜4週間 |

---

## 10. 未決定事項・検討課題

- [x] アプリ名の正式決定 → 仮称「搬送アシスト」で進行
- [x] 葬儀社側からの空き情報入力フロー → **葬儀社がFAX等で送付する紙資料を、配車担当がスマホで撮影して登録**
- [x] 個人情報の取り扱いポリシー → 現時点では不要。将来拡張時に検討
- [x] 初期導入対象エリア → **豊橋市周辺**
- [x] 友引などの決まっているデータ → **六曜カレンダー機能として要件 2.5 に追加済み**
- [x] 利用料金モデル → 現時点ではスコープ外
- [x] 既存の業務システムとの連携 → 現時点ではスコープ外
