# 運用マニュアル：搬送アシスト

---

## 1. システム構成

| サービス | プロバイダ | 管理URL |
|---------|-----------|---------|
| フロントエンド | Vercel | https://vercel.com/dashboard |
| データベース | Supabase | https://app.supabase.com |
| AI/OCR | Google AI Studio | https://aistudio.google.com |
| プッシュ通知 | Firebase | https://console.firebase.google.com |

---

## 2. 日常運用

### 2.1 ヘルスチェック

| 対象 | 確認方法 | 頻度 |
|------|---------|------|
| アプリ稼働 | https://hansou-assist.vercel.app にアクセス | 毎朝 |
| DB接続 | Supabase ダッシュボード → Health | 毎朝 |
| API呼び出し量 | Google AI Studio → 使用量 | 週1回 |
| エラーログ | Vercel → Logs タブ | 異常時 |

### 2.2 ユーザー管理

**新規ユーザー追加：**
1. 管理者アカウントでログイン
2. 右上ギアアイコン → ユーザー管理
3. 「招待」ボタン → メールアドレス + ロール選択
4. 招待メールが送信される
5. ユーザーがリンクからパスワード設定 → 利用開始

**ロール変更：**
1. 管理者画面 → ユーザー管理
2. 対象ユーザーのロールを変更
3. 即時反映

**アカウント無効化：**
1. 管理者画面 → ユーザー管理
2. 対象ユーザーの「無効化」ボタン
3. ログイン不可になる（データは保持）

### 2.3 施設・ホール管理

**新規施設追加：**
1. 管理者画面 → 施設管理
2. 「施設追加」→ 施設名、エリア、電話番号を入力
3. 「ホール追加」→ ホール名、収容人数、控室有無を入力
4. 保存 → スケジュール一覧に反映

**休業日登録（友引以外）：**
1. 管理者画面 → 休業日管理
2. カレンダーから日付を選択
3. 対象施設（全施設 or 個別）と理由を入力
4. 保存 → カレンダービューに反映

### 2.4 六曜データ

- アプリに5年分の六曜データが事前登録済み
- 追加が必要な場合は管理者がSupabaseのrokuyo テーブルにデータを追加
- 友引の日は自動的に「葬儀なし」としてブロック表示される

---

## 3. バックアップ・復旧

### 3.1 自動バックアップ

| 対象 | 方式 | 頻度 | 保持期間 |
|------|------|------|---------|
| データベース | Supabase Point-in-Time Recovery | 連続 | 7日間 |
| ストレージ（画像） | Supabase Storage | 自動 | 無制限 |
| ソースコード | GitHub | 毎コミット | 無制限 |

### 3.2 手動バックアップ（推奨：月1回）

```bash
# Supabase CLIでデータをエクスポート
npx supabase db dump -f backup_YYYYMMDD.sql

# 特定テーブルのみエクスポート
npx supabase db dump --data-only -t schedules,facilities,halls -f schedules_backup.sql
```

### 3.3 復旧手順

**データベース復旧：**
1. Supabase ダッシュボード → Settings → Database
2. Point-in-Time Recovery → 復旧ポイントを選択
3. 復旧を実行（数分かかる）

**手動バックアップからの復旧：**
```bash
npx supabase db reset
psql -h db.xxxx.supabase.co -U postgres -f backup_YYYYMMDD.sql
```

---

## 4. 障害対応

### 4.1 障害レベル定義

| レベル | 定義 | 対応時間 |
|-------|------|---------|
| **Critical** | アプリにアクセスできない | 即時対応 |
| **High** | スケジュール登録/表示ができない | 1時間以内 |
| **Medium** | OCR/チャットが動作しない | 翌営業日 |
| **Low** | UI表示の軽微な問題 | 次回リリース |

### 4.2 よくある障害と対処

**アプリが表示されない：**
1. Vercel ダッシュボードでデプロイ状況を確認
2. Supabase ダッシュボードでDB稼働を確認
3. 必要に応じて過去のデプロイにロールバック（Vercel → Deployments → 過去のデプロイを選択 → Promote to Production）

**OCRが動作しない：**
1. Google AI Studio で API使用量を確認（制限超過の可能性）
2. Vercel Logs でエラーメッセージを確認
3. 日次制限（100回/日）に達している場合は翌日に自動復旧
4. 緊急時は手動入力で対応

**リアルタイム同期が止まった：**
1. ブラウザをリロード
2. Supabase ダッシュボード → Realtime の接続状態を確認
3. 改善しない場合、Supabase のプロジェクト再起動

**ログインできない：**
1. パスワードリセットメールを送信（ログイン画面から）
2. 管理者が Supabase Auth ダッシュボードでユーザー状態を確認
3. アカウントが無効化されていないか確認

---

## 5. API費用管理

### 5.1 月間コスト見積もり

| サービス | 無料枠 | 月間見積もり |
|---------|-------|------------|
| Supabase (Free) | 500MB DB, 2GB Storage | $0 |
| Vercel (Hobby) | 100GB帯域 | $0 |
| Gemini API | 1500 RPD (Flash) | ~$10-30 |
| Firebase (Spark) | 月500K通知 | $0 |
| **合計** | | **~$10-30/月** |

### 5.2 コスト監視

- Google AI Studio の使用量ダッシュボードを週1回確認
- 月額$50を超えそうな場合はアラートメールが届くよう設定
- OCR/チャットの日次制限で制御

---

## 6. セキュリティ運用

### 6.1 定期チェック項目

| 項目 | 頻度 | 担当 |
|------|------|------|
| 不審なログイン試行の確認 | 週1回 | 管理者 |
| APIキーのローテーション | 3ヶ月に1回 | 管理者 |
| Supabase RLS ポリシーの確認 | リリース時 | 開発者 |
| 依存パッケージの脆弱性チェック | 月1回 | 開発者 |

### 6.2 APIキーローテーション手順

1. 新しいキーを発行（Supabase / Google AI Studio）
2. Vercel の環境変数を新しいキーに更新
3. 再デプロイ
4. 旧キーを無効化
5. 動作確認

---

## 7. 連絡先

| 役割 | 担当 | 連絡先 |
|------|------|-------|
| システム管理者 | （要設定） | （要設定） |
| 開発担当 | （要設定） | （要設定） |
| Supabase サポート | Supabase | https://supabase.com/support |
| Vercel サポート | Vercel | https://vercel.com/support |
